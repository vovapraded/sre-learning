---

# Проект: Distributed Metrics Storage with Monitoring

## Цель проекта:

Разработать микросервисное приложение на Java, которое:

* работает в Kubernetes,
* использует Istio для управления сетевыми взаимодействиями,
* деплоится через Helm,
* собирает собственные метрики в Prometheus,
* использует promQL для запросов к метрикам,
* моделирует простую распределённую базу данных с репликацией данных между нодами,
* реализует принципы мониторинга 4 Golden Signals, RED, USE.

---

## Стек технологий:

* Java 21 (или 17) + Spring Boot 3.x
* Kubernetes (k3d, minikube или полноценный кластер)
* Istio (Ingress Gateway + Traffic Shaping)
* Helm (для описания чарта деплоя)
* Prometheus (мониторинг)
* Grafana (визуализация метрик)
* PostgreSQL или встраиваемое хранилище типа H2
* Docker (сборка контейнеров)
* Prometheus Java Client (библиотека для метрик)
* Distributed Data Replication — через REST или Event-Driven модель.

---

## Архитектура:

* 2 микросервиса:

    * NodeService — эмулирует хранение данных и репликацию.
    * GatewayService — принимает внешние запросы, роутит их на NodeService.

* Распределённая запись данных: запись приходит в GatewayService, который реплицирует данные на 2+ NodeService инстанса.

* Мониторинг:

    * Каждый сервис экспонирует /actuator/prometheus с кастомными метриками: latency, throughput, error rate, saturation.
    * Prometheus собирает метрики по сервисам через ServiceDiscovery.

* Репликация данных:

    * При записи на одну ноду, она рассылает данные на реплики через REST-вызовы.
    * Можно добавить механизм "Eventually Consistent" (например, подтверждение через очередь/таску).

* Ошибки и отказоустойчивость:

    * Имитация случайных ошибок или задержек (например, через Istio Fault Injection).

* Helm Chart:

    * Чарт для всего проекта: описывает деплой сервисов + Prometheus + Grafana + Istio Gateway.

---

## Что будет покрыто:

| Требование                                  | Как покрывается                                                                                                                                       |
| :------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------- |
| Prometheus + promQL                         | Метрики будут собираться Prometheus'ом, запросы можно писать на promQL для анализа (например, средняя задержка записи, количество ошибок репликации). |
| 4 Golden Signals                            | Метрики: Latency (задержка ответа), Traffic (количество запросов), Errors (кол-во ошибок), Saturation (нагрузка на сервисы).                          |
| RED                                         | Response time, Error rate, Request rate — все собираются в Prometheus.                                                                                |
| USE                                         | Метрики ресурсов: загрузка CPU, использование памяти через Node Exporter или встроенные метрики.                                                      |
| Cloud инструменты (Kubernetes, Istio, Helm) | Деплой всех сервисов через Helm на Kubernetes, настройка сетевых правил через Istio.                                                                  |
| Распределенное хранение                     | NodeService хранит данные локально, реплицирует другим NodeService.                                                                                   |
| Репликация данных                           | REST-репликация при записи данных на одну из нод.                                                                                                     |

---

## Конкретные задачи в проекте:

1. NodeService:

    * POST /data — сохраняет запись и реплицирует её другим NodeService.
    * GET /data/{key} — получить запись.
    * Кастомные Prometheus метрики:

        * latency записи/чтения,
        * количество ошибок репликации.

2. GatewayService:

    * Принимает все запросы от клиента.
    * Распределяет запросы между доступными NodeService (например, round-robin или random).
    * Метрики RED для входящего трафика.

3. Репликация данных:

    * После сохранения данных, сервис сам делает POST запросы на другие инстансы NodeService.
    * Логика "какая-то нода может временно упасть" — реализуется через retry/backoff.

4. Monitoring:

    * Настроить Prometheus scrape targets.
    * В Grafana дашборде показать:

        * Latency по сервисам.
        * Ошибки репликации.
        * Количество обработанных запросов.

5. Kubernetes + Istio:

    * Ingress через Istio Gateway.
    * Настроить fault injection (например, добавить искусственные 10% ошибок или 500ms задержки).

6. Helm:

    * Один чарт, включающий:

        * Деплой всех сервисов.
        * Prometheus и Grafana.
        * Istio Gateway + VirtualService + DestinationRule.

---

## Бонусные идеи:

* Добавить сохранение состояния в PostgreSQL/H2.
* Добавить механизмы самовосстановления (например, через cron задачи репликации).
* Реализовать Circuit Breaker на клиентах через Resilience4j или встроенные механизмы Istio.

---

## Как защитить этот проект:

Когда ты будешь презентовать проект, можно рассказать:

* "Я построил мини-распределённую БД с репликацией, заточенную под принципы Golden Signals, RED, USE."
* "В проекте используется promQL для аналитики метрик задержек, ошибок, трафика."
* "Я развернул всё в Kubernetes с помощью Helm, настроил Istio для управления трафиком и имитации сбоев."
* "В распределённой архитектуре я реализовал репликацию данных и обработку ошибок с backoff/retry."
* "Мониторинг строится на Prometheus и Grafana, с полным покрытием ключевых метрик."

---
